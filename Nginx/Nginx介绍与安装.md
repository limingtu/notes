# Nginx介绍与安装

#### 常用的Web服务器简介

> `查看查看服务器的市场占有率：` [https://news.netcraft.com](https://news.netcraft.com)

+ **Apache**
  - Apache(http://httpd.apache.org), apache仍然是世界上用的最多的Web服务器，市场占有率60%左右，模块非常丰富，系统稳定，可移值性好，但是比较消耗资源。
+ **Lighttpd**
  - Lighttpd(http://www.lighttpd.net), Lighttpd是一个德国人写的开源软件，目标是提供一个高性的网站，它具有内存开销低，CPU占有率低，效能好以及模块丰富，是Nginx的重要竞争对手之一。
+ **Tomcat**
  - Tomcat(http://tomcat.apache.org), Tomcat是一个开源，运行servlet和jsp web应用软件的基于Java的web服务器，但是Tomcat对静态文件、高并发的处理能力弱。
+ **WebSphere**
  - IBM WebSphere服务器，WebSphere是一种功能完善、开放的web应用程序服务器，是IBM电子商务计划的核心部分，它是基于Java的应用环境，范围从简单到高级直至企业级，相对于其他Web服务器来说，应用数量少。
+ **IIS**
  - Microsoft IIS， Internet Information Services（IIS，互联网信息服务），是由微软公司提供的基于运行Microsoft Windows的互联网基本服务。最初是Windows NT版本的可选包，随后内置在Windows 2000、Windows XP Professional和Windows Server 2003一起发行，但在Windows XP Home版本上并没有IIS。IIS是一种Web服务组件，其中包括web服务器、FTP服务等。

#### 什么是Nginx？

> `Nginx是俄罗斯人Lgor Sysoev(塞索耶夫)编写的一款高性能的HTTP和反向代理服务器。`

**Nginx 是一个高性能的 Web 和反向代理服务器, 它具有有很多非常优越的特性:**

+ **作为 Web 服务器**
  - 相比 Apache，Nginx 使用更少的资源，支持更多的并发连接，体现更高的效率，这点使 Nginx 尤其受到虚拟主机提供商的欢迎。能够支持高达 50,000 个并发连接数的响应，感谢 Nginx 为我们选择了 epoll and kqueue 作为开发模型。
+ **作为负载均衡服务器**
  - Nginx 既可以在内部直接支持 Rails 和 PHP，也可以支持作为 HTTP代理服务器对外进行服务。Nginx 用 C 编写, 不论是系统资源开销还是 CPU 使用效率都比 Perlbal 要好的多。
+ **作为邮件代理服务器**
  - Nginx 同时也是一个非常优秀的邮件代理服务器（最早开发这个产品的目的之一也是作为邮件代理服务器）。

> `Nginx 安装非常的简单，配置文件 非常简洁（还能够支持perl语法），Bugs非常少的服务器: Nginx 启动特别容易，并且几乎可以做到7*24不间断运行，即使运行数个月也不需要重新启动。你还能够在 不间断服务的情况下进行软件版本的升级。`

#### 选择Nginx的理由

+ **跨平台**
  - 相比 Apache，Nginx 使用更少的资源，支持更多的并发连接，体现更高的效率，这点使 Nginx 尤其受到虚拟主机提供商的欢迎。能够支持高达 50,000 个并发连接数的响应，感谢 Nginx 为我们选择了 epoll and kqueue 作为开发模型。
+ **配置异常简单**
  - 相比 Apache，Nginx 使用更少的资源，支持更多的并发连接，体现更高的效率，这点使 Nginx 尤其受到虚拟主机提供商的欢迎。能够支持高达 50,000 个并发连接数的响应，感谢 Nginx 为我们选择了 epoll and kqueue 作为开发模型。
+ **非阻塞、高并发连接**
  - 相比 Apache，Nginx 使用更少的资源，支持更多的并发连接，体现更高的效率，这点使 Nginx 尤其受到虚拟主机提供商的欢迎。能够支持高达 50,000 个并发连接数的响应，感谢 Nginx 为我们选择了 epoll and kqueue 作为开发模型。  
+ **事件驱动**
  - 通信机制采用epoll模型，支持更大的并发连接。
+ **master/worker结构**
  - 一个master进程，生成一个或多个worker进程。
+ **内存消耗小**
  - 处理大并发的请求内存消耗非常小。在3万并发连接下，开启的10个Nginx 进程才消耗150M内存（15M*10=150M） 成本低廉：Nginx为开源软件，可以免费使用。而购买F5 BIG-IP、NetScaler等硬件负载均衡交换机则需要十多万至几十万人民币。
+ **内置的健康检查功能**
  - 如果 Nginx Proxy 后端的某台 Web 服务器宕机了，不会影响前端访问。
+ **节省带宽**
  - 支持 GZIP 压缩，可以添加浏览器本地缓存的 Header 头。
+ **稳定性高**  
  - 用于反向代理，宕机的概率微乎其微。

#### Nginx不为人知的特点

> + nginx代理和后端web服务器间无需长连接；
> + 接收用户请求是异步的，即先将用户请求全部接收下来，再一次性发送后后端web服务器，极大的减轻后端web服务器的压力；
> + 发送响应报文时，是边接收来自后端web服务器的数据，边发送给客户端的；
> + 网络依赖型低。NGINX对网络的依赖程度非常低，理论上讲，只要能够ping通就可以实施负载均衡，而且可以有效区分内网和外网流量；
> + 支持服务器检测。NGINX能够根据应用服务器处理页面返回的状态码、超时信息等检测服务器是否出现故障，并及时返回错误的请求重新提交到其它节点上。

#### 什么是正向代理、反向代理？

+ **正向代理**
> 正向代理,也就是传说中的代理, 他的工作原理就像一个跳板,简单的说：
我是一个用户,我访问不了某网站,但是我能访问一个代理服务器。 这个代理服务器呢,他能访问那个我不能访问的网站，于是我先连上代理服务器,告诉他我需要那个无法访问网站的内容。代理服务器去取回来,然后返回给我。
从网站的角度,只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求,也隐藏了用户的资料,这取决于代理告不告诉网站。
结论就是：正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。   
**比如**：翻墙软件、goAgent。

![正向代理]()

+ **反向代理**
> 例用户访问 http://ooxx.me/readme   
但ooxx.me上并不存在readme页面   
他是偷偷从另外一台服务器上取回来,然后作为自己的内容吐给用户   
但用户并不知情   
这很正常,用户一般都很笨   
这里所提到的 ooxx.me 这个域名对应的服务器就设置了反向代理功能   
结论就是：   
反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理 的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容 原本就是它自己的一样。

![反向代理]()

+ **二者区别**

> 正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。   
反向代理的典型用途是将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。   
正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。   
反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。

#### Nginx内部进程模型

![Nginx内部进程模型]()

#### Nginx是如何处理一个请求？

> 首先，nginx在启动时，会解析配置文件，得到需要监听的端口与ip地址，然后在nginx的master进程里面，先初始化好这个监控的socket(创建socket，设置addrreuse等选项，绑定到指定的ip地址端口，再listen)，然后再fork(一个现有进程可以调用fork函数创建一个新进程。由fork创建的新进程被称为子进程 )出多个子进程出来，然后子进程会竞争accept新的连接。此时，客户端就可以向nginx发起连接了。当客户端与nginx进行三次握手，与nginx建立好一个连接后，此时，某一个子进程会accept成功，得到这个建立好的连接的socket，然后创建nginx对连接的封装，即ngx_connection_t结构体。接着，设置读写事件处理函数并添加读写事件来与客户端进行数据的交换。最后，nginx或客户端来主动关掉连接，到此，一个连接就寿终正寝了。
当然，nginx也是可以作为客户端来请求其它server的数据的（如upstream模块），此时，与其它server创建的连接，也封装在ngx_connection_t中。作为客户端，nginx先获取一个ngx_connection_t结构体，然后创建socket，并设置socket的属性（ 比如非阻塞）。然后再通过添加读写事件，调用connect/read/write来调用连接，最后关掉连接，并释放ngx_connection_t。

#### Nginx的典型应用场景

![Nginx的典型应用场景]()

#### Nginx的安装

+ **Nginx 的windows安装**
> http://nginx.org

  **下载nginx并演示**
> `启动Nginx :  start nginx   使用：http://localhost `  
> `强制关闭Nginx ： nginx -s stop`  
> `安全关闭Nginx : nginx -s quit  `  
> `改变配置文件的时候，重启nginx工作进程，来时配置文件生效 : nginx -s reload`  
> `检查nginx的conf目录下的nginx.conf的语法是否正确 ： nginx -t`  
> `查看nginx进程：tasklist /fi "imagename eq nginx.exe"  `  
> `nginx -V : 查看该Win32平台编译版支持哪些模块`

+ **Nginx 的CentOS7安装**

  > `yum -y install net-tools`
